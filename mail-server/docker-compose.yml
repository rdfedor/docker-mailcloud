version: '3'
services:
  mail:
    build: ./mail-server/.
    hostname: ${MAIL_HOSTNAME}
    domainname: ${DOMAINNAME}
    container_name: ${MAIL_CONTAINER_NAME}
    ports:
    - 25:25
    - 143:143
    - 587:587
    - 993:993
    - 4190:4190
    volumes:
    - maildata:/var/mail
    - mailstate:/var/mail-state
    - maillogs:/var/log/mail
    - ./mail-server/config/:/tmp/docker-mailserver/
    env_file:
    - .env
    - env-mailserver
    cap_add:
    - NET_ADMIN
    - SYS_PTRACE
    restart: always
    depends_on:
      - mail-manager

  mail-manager:
    build: ./mail-server/manager
    container_name: ${MAIL_CONTAINER_NAME}-manager
    volumes:
      - maildata:/var/mail
      - ./mail-server/config/:/tmp/docker-mailserver/
    env_file:
      - .env
      - env-mailserver
    restart: always

  autodiscovery:
    image: jsmitsnl/docker-email-autodiscover:latest
    hostname: autodiscover
    domainname: ${DOMAINNAME}
    container_name: mail-autodiscover
    restart: always
    environment:
    - DOMAIN=${DOMAINNAME}
    - IMAP_HOST=imap.${DOMAINNAME}
    - SMTP_HOST=smtp.${DOMAINNAME}
    - VIRTUAL_HOST=autoconfig.${DOMAINNAME},autodiscover.${DOMAINNAME}
    - LETSENCRYPT_HOST=autoconfig.${DOMAINNAME},autodiscover.${DOMAINNAME}
    - LETSENCRYPT_EMAIL=support@${DOMAINNAME}
    networks:
    - proxy-tier
    - default
    
volumes:
  maildata:
    driver: local
  mailstate:
    driver: local
  maillogs:
    driver: local

networks:
  proxy-tier:
